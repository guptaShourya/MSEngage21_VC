{"ast":null,"code":"\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _assign = require(\"babel-runtime/core-js/object/assign\");\n\nvar _assign2 = _interopRequireDefault(_assign);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Users = void 0;\n\nvar events_1 = require(\"events\");\n\nvar user_1 = require(\"../user\");\n\nvar userdescriptors_1 = require(\"./userdescriptors\");\n/**\n * @classdesc Container for known users\n * @fires Users#userUpdated\n */\n\n\nvar Users = function (_events_1$EventEmitte) {\n  (0, _inherits3.default)(Users, _events_1$EventEmitte);\n\n  function Users(configuration, services) {\n    (0, _classCallCheck3.default)(this, Users);\n\n    var _this = (0, _possibleConstructorReturn3.default)(this, (Users.__proto__ || (0, _getPrototypeOf2.default)(Users)).call(this));\n\n    _this.configuration = configuration;\n    _this.services = services;\n    var userLinks = {\n      self: configuration.links.users + \"/\" + configuration.userIdentity\n    };\n    _this.fifoStack = [];\n    _this.myself = new user_1.User(_this.configuration.userIdentity, _this.configuration.userInfo, userLinks, _this.configuration, _this.services);\n\n    _this.myself.on('updated', function (args) {\n      return _this.emit('userUpdated', args);\n    });\n\n    _this.myself.on('userSubscribed', function () {\n      return _this.emit('userSubscribed', _this.myself);\n    });\n\n    _this.myself.on('userUnsubscribed', function () {\n      _this.emit('userUnsubscribed', _this.myself);\n\n      _this.myself._ensureFetched();\n    });\n\n    _this.subscribedUsers = new _map2.default();\n    _this.userDescriptors = new userdescriptors_1.UserDescriptors(_this.configuration, (0, _assign2.default)((0, _assign2.default)({}, _this.services), {\n      users: _this\n    }));\n    return _this;\n  }\n\n  (0, _createClass3.default)(Users, [{\n    key: \"handleUnsubscribeUser\",\n    value: function handleUnsubscribeUser(user) {\n      if (this.subscribedUsers.has(user.identity)) {\n        this.subscribedUsers.delete(user.identity);\n      }\n\n      var foundItemIndex = -1;\n      var foundItem = this.fifoStack.find(function (item, index) {\n        if (item == user.identity) {\n          foundItemIndex = index;\n          return true;\n        }\n\n        return false;\n      });\n\n      if (foundItem) {\n        this.fifoStack.splice(foundItemIndex, 1);\n      }\n\n      this.emit('userUnsubscribed', user);\n    }\n  }, {\n    key: \"handleSubscribeUser\",\n    value: function handleSubscribeUser(user) {\n      if (this.subscribedUsers.has(user.identity)) {\n        return;\n      }\n\n      if (this.fifoStack.length >= this.configuration.userInfosToSubscribe) {\n        this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe();\n      }\n\n      this.fifoStack.push(user.identity);\n      this.subscribedUsers.set(user.identity, user);\n      this.emit('userSubscribed', user);\n    }\n    /**\n     * Gets user, if it's in subscribed list - then return the user object from it,\n     * if not - then subscribes and adds user to the FIFO stack\n     * @returns {Promise<User>} Fully initialized user\n     */\n\n  }, {\n    key: \"getUser\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(identity) {\n        var _this2 = this;\n\n        var entityName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n        var user, userDescriptor, userLinks;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.myself._ensureFetched();\n\n              case 2:\n                if (!(identity == this.myself.identity)) {\n                  _context.next = 4;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", this.myself);\n\n              case 4:\n                user = this.subscribedUsers.get(identity);\n\n                if (user) {\n                  _context.next = 18;\n                  break;\n                }\n\n                if (entityName) {\n                  _context.next = 11;\n                  break;\n                }\n\n                _context.next = 9;\n                return this.getUserDescriptor(identity);\n\n              case 9:\n                userDescriptor = _context.sent;\n                entityName = userDescriptor._getDescriptor().sync_objects.user_info_map;\n\n              case 11:\n                userLinks = {\n                  self: this.configuration.links.users + \"/\" + identity\n                };\n                user = new user_1.User(identity, entityName, userLinks, this.configuration, this.services);\n                user.on('updated', function (args) {\n                  return _this2.emit('userUpdated', args);\n                });\n                user.on('userSubscribed', function () {\n                  return _this2.handleSubscribeUser(user);\n                });\n                user.on('userUnsubscribed', function () {\n                  return _this2.handleUnsubscribeUser(user);\n                });\n                _context.next = 18;\n                return user._ensureFetched();\n\n              case 18:\n                return _context.abrupt(\"return\", user);\n\n              case 19:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function getUser(_x2) {\n        return _ref.apply(this, arguments);\n      }\n\n      return getUser;\n    }()\n    /**\n     * @returns {Promise<UserDescriptor>} User descriptor\n     */\n\n  }, {\n    key: \"getUserDescriptor\",\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(identity) {\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", this.userDescriptors.getUserDescriptor(identity));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function getUserDescriptor(_x3) {\n        return _ref2.apply(this, arguments);\n      }\n\n      return getUserDescriptor;\n    }()\n    /**\n     * @returns {Promise<Paginator<UserDescriptor>>} Users descriptors page for given channel sid\n     */\n\n  }, {\n    key: \"getChannelUserDescriptors\",\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(channelSid) {\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                return _context3.abrupt(\"return\", this.userDescriptors.getChannelUserDescriptors(channelSid));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getChannelUserDescriptors(_x4) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return getChannelUserDescriptors;\n    }()\n    /**\n     * @returns {Promise<Array<User>>} returns list of subscribed User objects {@see User}\n     */\n\n  }, {\n    key: \"getSubscribedUsers\",\n    value: function () {\n      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {\n        var users;\n        return _regenerator2.default.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _context4.next = 2;\n                return this.myself._ensureFetched();\n\n              case 2:\n                users = [this.myself];\n                this.subscribedUsers.forEach(function (user) {\n                  return users.push(user);\n                });\n                return _context4.abrupt(\"return\", users);\n\n              case 5:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function getSubscribedUsers() {\n        return _ref4.apply(this, arguments);\n      }\n\n      return getSubscribedUsers;\n    }()\n  }]);\n  return Users;\n}(events_1.EventEmitter);\n\nexports.Users = Users;","map":{"version":3,"sources":["/Users/shouryagupta/Desktop/MS Engage 21/MSEngage21_VC/node_modules/twilio-chat/browser/data/users.js"],"names":["_regenerator","require","_regenerator2","_interopRequireDefault","_asyncToGenerator2","_asyncToGenerator3","_assign","_assign2","_map","_map2","_getPrototypeOf","_getPrototypeOf2","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_possibleConstructorReturn2","_possibleConstructorReturn3","_inherits2","_inherits3","obj","__esModule","default","Object","defineProperty","exports","value","Users","events_1","user_1","userdescriptors_1","_events_1$EventEmitte","configuration","services","_this","__proto__","call","userLinks","self","links","users","userIdentity","fifoStack","myself","User","userInfo","on","args","emit","_ensureFetched","subscribedUsers","userDescriptors","UserDescriptors","key","handleUnsubscribeUser","user","has","identity","delete","foundItemIndex","foundItem","find","item","index","splice","handleSubscribeUser","length","userInfosToSubscribe","get","shift","unsubscribe","push","set","_ref","mark","_callee","_this2","entityName","arguments","undefined","userDescriptor","wrap","_callee$","_context","prev","next","abrupt","getUserDescriptor","sent","_getDescriptor","sync_objects","user_info_map","stop","getUser","_x2","apply","_ref2","_callee2","_callee2$","_context2","_x3","_ref3","_callee3","channelSid","_callee3$","_context3","getChannelUserDescriptors","_x4","_ref4","_callee4","_callee4$","_context4","forEach","getSubscribedUsers","EventEmitter"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _assign = require(\"babel-runtime/core-js/object/assign\");\n\nvar _assign2 = _interopRequireDefault(_assign);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Users = void 0;\nvar events_1 = require(\"events\");\nvar user_1 = require(\"../user\");\nvar userdescriptors_1 = require(\"./userdescriptors\");\n/**\n * @classdesc Container for known users\n * @fires Users#userUpdated\n */\n\nvar Users = function (_events_1$EventEmitte) {\n    (0, _inherits3.default)(Users, _events_1$EventEmitte);\n\n    function Users(configuration, services) {\n        (0, _classCallCheck3.default)(this, Users);\n\n        var _this = (0, _possibleConstructorReturn3.default)(this, (Users.__proto__ || (0, _getPrototypeOf2.default)(Users)).call(this));\n\n        _this.configuration = configuration;\n        _this.services = services;\n        var userLinks = {\n            self: configuration.links.users + \"/\" + configuration.userIdentity\n        };\n        _this.fifoStack = [];\n        _this.myself = new user_1.User(_this.configuration.userIdentity, _this.configuration.userInfo, userLinks, _this.configuration, _this.services);\n        _this.myself.on('updated', function (args) {\n            return _this.emit('userUpdated', args);\n        });\n        _this.myself.on('userSubscribed', function () {\n            return _this.emit('userSubscribed', _this.myself);\n        });\n        _this.myself.on('userUnsubscribed', function () {\n            _this.emit('userUnsubscribed', _this.myself);\n            _this.myself._ensureFetched();\n        });\n        _this.subscribedUsers = new _map2.default();\n        _this.userDescriptors = new userdescriptors_1.UserDescriptors(_this.configuration, (0, _assign2.default)((0, _assign2.default)({}, _this.services), { users: _this }));\n        return _this;\n    }\n\n    (0, _createClass3.default)(Users, [{\n        key: \"handleUnsubscribeUser\",\n        value: function handleUnsubscribeUser(user) {\n            if (this.subscribedUsers.has(user.identity)) {\n                this.subscribedUsers.delete(user.identity);\n            }\n            var foundItemIndex = -1;\n            var foundItem = this.fifoStack.find(function (item, index) {\n                if (item == user.identity) {\n                    foundItemIndex = index;\n                    return true;\n                }\n                return false;\n            });\n            if (foundItem) {\n                this.fifoStack.splice(foundItemIndex, 1);\n            }\n            this.emit('userUnsubscribed', user);\n        }\n    }, {\n        key: \"handleSubscribeUser\",\n        value: function handleSubscribeUser(user) {\n            if (this.subscribedUsers.has(user.identity)) {\n                return;\n            }\n            if (this.fifoStack.length >= this.configuration.userInfosToSubscribe) {\n                this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe();\n            }\n            this.fifoStack.push(user.identity);\n            this.subscribedUsers.set(user.identity, user);\n            this.emit('userSubscribed', user);\n        }\n        /**\n         * Gets user, if it's in subscribed list - then return the user object from it,\n         * if not - then subscribes and adds user to the FIFO stack\n         * @returns {Promise<User>} Fully initialized user\n         */\n\n    }, {\n        key: \"getUser\",\n        value: function () {\n            var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(identity) {\n                var _this2 = this;\n\n                var entityName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n                var user, userDescriptor, userLinks;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                _context.next = 2;\n                                return this.myself._ensureFetched();\n\n                            case 2:\n                                if (!(identity == this.myself.identity)) {\n                                    _context.next = 4;\n                                    break;\n                                }\n\n                                return _context.abrupt(\"return\", this.myself);\n\n                            case 4:\n                                user = this.subscribedUsers.get(identity);\n\n                                if (user) {\n                                    _context.next = 18;\n                                    break;\n                                }\n\n                                if (entityName) {\n                                    _context.next = 11;\n                                    break;\n                                }\n\n                                _context.next = 9;\n                                return this.getUserDescriptor(identity);\n\n                            case 9:\n                                userDescriptor = _context.sent;\n\n                                entityName = userDescriptor._getDescriptor().sync_objects.user_info_map;\n\n                            case 11:\n                                userLinks = {\n                                    self: this.configuration.links.users + \"/\" + identity\n                                };\n\n                                user = new user_1.User(identity, entityName, userLinks, this.configuration, this.services);\n                                user.on('updated', function (args) {\n                                    return _this2.emit('userUpdated', args);\n                                });\n                                user.on('userSubscribed', function () {\n                                    return _this2.handleSubscribeUser(user);\n                                });\n                                user.on('userUnsubscribed', function () {\n                                    return _this2.handleUnsubscribeUser(user);\n                                });\n                                _context.next = 18;\n                                return user._ensureFetched();\n\n                            case 18:\n                                return _context.abrupt(\"return\", user);\n\n                            case 19:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function getUser(_x2) {\n                return _ref.apply(this, arguments);\n            }\n\n            return getUser;\n        }()\n        /**\n         * @returns {Promise<UserDescriptor>} User descriptor\n         */\n\n    }, {\n        key: \"getUserDescriptor\",\n        value: function () {\n            var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(identity) {\n                return _regenerator2.default.wrap(function _callee2$(_context2) {\n                    while (1) {\n                        switch (_context2.prev = _context2.next) {\n                            case 0:\n                                return _context2.abrupt(\"return\", this.userDescriptors.getUserDescriptor(identity));\n\n                            case 1:\n                            case \"end\":\n                                return _context2.stop();\n                        }\n                    }\n                }, _callee2, this);\n            }));\n\n            function getUserDescriptor(_x3) {\n                return _ref2.apply(this, arguments);\n            }\n\n            return getUserDescriptor;\n        }()\n        /**\n         * @returns {Promise<Paginator<UserDescriptor>>} Users descriptors page for given channel sid\n         */\n\n    }, {\n        key: \"getChannelUserDescriptors\",\n        value: function () {\n            var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(channelSid) {\n                return _regenerator2.default.wrap(function _callee3$(_context3) {\n                    while (1) {\n                        switch (_context3.prev = _context3.next) {\n                            case 0:\n                                return _context3.abrupt(\"return\", this.userDescriptors.getChannelUserDescriptors(channelSid));\n\n                            case 1:\n                            case \"end\":\n                                return _context3.stop();\n                        }\n                    }\n                }, _callee3, this);\n            }));\n\n            function getChannelUserDescriptors(_x4) {\n                return _ref3.apply(this, arguments);\n            }\n\n            return getChannelUserDescriptors;\n        }()\n        /**\n         * @returns {Promise<Array<User>>} returns list of subscribed User objects {@see User}\n         */\n\n    }, {\n        key: \"getSubscribedUsers\",\n        value: function () {\n            var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {\n                var users;\n                return _regenerator2.default.wrap(function _callee4$(_context4) {\n                    while (1) {\n                        switch (_context4.prev = _context4.next) {\n                            case 0:\n                                _context4.next = 2;\n                                return this.myself._ensureFetched();\n\n                            case 2:\n                                users = [this.myself];\n\n                                this.subscribedUsers.forEach(function (user) {\n                                    return users.push(user);\n                                });\n                                return _context4.abrupt(\"return\", users);\n\n                            case 5:\n                            case \"end\":\n                                return _context4.stop();\n                        }\n                    }\n                }, _callee4, this);\n            }));\n\n            function getSubscribedUsers() {\n                return _ref4.apply(this, arguments);\n            }\n\n            return getSubscribedUsers;\n        }()\n    }]);\n    return Users;\n}(events_1.EventEmitter);\n\nexports.Users = Users;"]},"metadata":{},"sourceType":"script"}