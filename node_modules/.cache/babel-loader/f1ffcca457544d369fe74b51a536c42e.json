{"ast":null,"code":"\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _stringify = require(\"babel-runtime/core-js/json/stringify\");\n\nvar _stringify2 = _interopRequireDefault(_stringify);\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Messages = void 0;\n\nvar events_1 = require(\"events\");\n\nvar logger_1 = require(\"../logger\");\n\nvar message_1 = require(\"../message\");\n\nvar log = logger_1.Logger.scope('Messages');\n/**\n * Represents the collection of messages in a channel\n */\n\nvar Messages = function (_events_1$EventEmitte) {\n  (0, _inherits3.default)(Messages, _events_1$EventEmitte);\n\n  function Messages(channel, configuration, services) {\n    (0, _classCallCheck3.default)(this, Messages);\n\n    var _this = (0, _possibleConstructorReturn3.default)(this, (Messages.__proto__ || (0, _getPrototypeOf2.default)(Messages)).call(this));\n\n    _this.channel = channel;\n    _this.configuration = configuration;\n    _this.services = services;\n    _this.messagesByIndex = new _map2.default();\n    _this.messagesListPromise = null;\n    return _this;\n  }\n  /**\n   * Subscribe to the Messages Event Stream\n   * @param {String} name - The name of Sync object for the Messages resource.\n   * @returns {Promise}\n   */\n\n\n  (0, _createClass3.default)(Messages, [{\n    key: \"subscribe\",\n    value: function subscribe(name) {\n      var _this2 = this;\n\n      return this.messagesListPromise = this.messagesListPromise || this.services.syncClient.list({\n        id: name,\n        mode: 'open_existing'\n      }).then(function (list) {\n        list.on('itemAdded', function (args) {\n          log.debug(_this2.channel.sid + ' itemAdded: ' + args.item.index);\n          var links = {\n            self: _this2.channel.links.messages + \"/\" + args.item.data.sid,\n            conversation: _this2.channel.links.self,\n            messages_receipts: _this2.channel.links.messages + \"/\" + args.item.data.sid + \"/Receipts\"\n          };\n          var message = new message_1.Message(args.item.index, args.item.data, _this2.channel, links, _this2.configuration, _this2.services);\n\n          if (_this2.messagesByIndex.has(message.index)) {\n            log.debug('Message arrived, but already known and ignored', _this2.channel.sid, message.index);\n            return;\n          }\n\n          _this2.messagesByIndex.set(message.index, message);\n\n          message.on('updated', function (args) {\n            return _this2.emit('messageUpdated', args);\n          });\n\n          _this2.emit('messageAdded', message);\n        });\n        list.on('itemRemoved', function (args) {\n          log.debug(_this2.channel.sid + ' itemRemoved: ' + args.index);\n          var index = args.index;\n\n          if (_this2.messagesByIndex.has(index)) {\n            var message = _this2.messagesByIndex.get(index);\n\n            _this2.messagesByIndex.delete(message.index);\n\n            message.removeAllListeners('updated');\n\n            _this2.emit('messageRemoved', message);\n          }\n        });\n        list.on('itemUpdated', function (args) {\n          log.debug(_this2.channel.sid + ' itemUpdated: ' + args.item.index);\n\n          var message = _this2.messagesByIndex.get(args.item.index);\n\n          if (message) {\n            message._update(args.item.data);\n          }\n        });\n        return list;\n      }).catch(function (err) {\n        _this2.messagesListPromise = null;\n\n        if (_this2.services.syncClient.connectionState != 'disconnected') {\n          log.error('Failed to get messages object for channel', _this2.channel.sid, err);\n        }\n\n        log.debug('ERROR: Failed to get messages object for channel', _this2.channel.sid, err);\n        throw err;\n      });\n    }\n  }, {\n    key: \"unsubscribe\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n        var entity;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                if (!this.messagesListPromise) {\n                  _context.next = 6;\n                  break;\n                }\n\n                _context.next = 3;\n                return this.messagesListPromise;\n\n              case 3:\n                entity = _context.sent;\n                entity.close();\n                this.messagesListPromise = null;\n\n              case 6:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function unsubscribe() {\n        return _ref.apply(this, arguments);\n      }\n\n      return unsubscribe;\n    }()\n    /**\n     * Send Message to the channel\n     * @param {String} message - Message to post\n     * @param {any} attributes Message attributes\n     * @returns Returns promise which can fail\n     */\n\n  }, {\n    key: \"send\",\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(message) {\n        var attributes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                log.debug('Sending text message', message, attributes);\n                _context2.next = 3;\n                return this.services.commandExecutor.mutateResource('post', this.channel.links.messages, {\n                  body: message || '',\n                  attributes: attributes !== undefined ? (0, _stringify2.default)(attributes) : undefined\n                });\n\n              case 3:\n                return _context2.abrupt(\"return\", _context2.sent);\n\n              case 4:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function send(_x2) {\n        return _ref2.apply(this, arguments);\n      }\n\n      return send;\n    }()\n    /**\n     * Send Media Message to the channel\n     * @param {FormData | Channel#SendMediaOptions} mediaContent - Media content to post\n     * @param {any} attributes Message attributes\n     * @returns Returns promise which can fail\n     */\n\n  }, {\n    key: \"sendMedia\",\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(mediaContent) {\n        var attributes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        var media, mediaOptions;\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                log.debug('Sending media message', mediaContent, attributes);\n                media = void 0;\n\n                if (!(typeof FormData !== 'undefined' && mediaContent instanceof FormData)) {\n                  _context3.next = 9;\n                  break;\n                }\n\n                log.debug('Sending media message as FormData', mediaContent, attributes);\n                _context3.next = 6;\n                return this.services.mcsClient.postFormData(mediaContent);\n\n              case 6:\n                media = _context3.sent;\n                _context3.next = 16;\n                break;\n\n              case 9:\n                log.debug('Sending media message as SendMediaOptions', mediaContent, attributes);\n                mediaOptions = mediaContent;\n\n                if (!(!mediaOptions.contentType || !mediaOptions.media)) {\n                  _context3.next = 13;\n                  break;\n                }\n\n                throw new Error('Media content <Channel#SendMediaOptions> must contain non-empty contentType and media');\n\n              case 13:\n                _context3.next = 15;\n                return this.services.mcsClient.post(mediaOptions.contentType, mediaOptions.media);\n\n              case 15:\n                media = _context3.sent;\n\n              case 16:\n                _context3.next = 18;\n                return this.services.commandExecutor.mutateResource('post', this.channel.links.messages, {\n                  media_sid: media.sid,\n                  attributes: attributes !== undefined ? (0, _stringify2.default)(attributes) : undefined\n                });\n\n              case 18:\n                return _context3.abrupt(\"return\", _context3.sent);\n\n              case 19:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function sendMedia(_x4) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return sendMedia;\n    }()\n    /**\n     * Returns messages from channel using paginator interface\n     * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 30.\n     * @param {String} [anchor] Most early message id which is already known, or 'end' by default\n     * @param {String} [direction] Pagination order 'backwards' or 'forward', or 'forward' by default\n     * @returns {Promise<Paginator<Message>>} last page of messages by default\n     */\n\n  }, {\n    key: \"getMessages\",\n    value: function getMessages(pageSize, anchor, direction) {\n      anchor = typeof anchor !== 'undefined' ? anchor : 'end';\n      direction = direction || 'backwards';\n      return this._getMessages(pageSize, anchor, direction);\n    }\n  }, {\n    key: \"wrapPaginator\",\n    value: function wrapPaginator(order, page, op) {\n      var _this3 = this; // We should swap next and prev page here, because of misfit of Sync and Chat paging conceptions\n\n\n      var shouldReverse = order === 'desc';\n\n      var np = function np() {\n        return page.nextPage().then(function (x) {\n          return _this3.wrapPaginator(order, x, op);\n        });\n      };\n\n      var pp = function pp() {\n        return page.prevPage().then(function (x) {\n          return _this3.wrapPaginator(order, x, op);\n        });\n      };\n\n      return op(page.items).then(function (items) {\n        return {\n          items: items.sort(function (x, y) {\n            return x.index - y.index;\n          }),\n          hasPrevPage: shouldReverse ? page.hasNextPage : page.hasPrevPage,\n          hasNextPage: shouldReverse ? page.hasPrevPage : page.hasNextPage,\n          prevPage: shouldReverse ? np : pp,\n          nextPage: shouldReverse ? pp : np\n        };\n      });\n    }\n  }, {\n    key: \"_upsertMessage\",\n    value: function _upsertMessage(index, value) {\n      var _this4 = this;\n\n      var cachedMessage = this.messagesByIndex.get(index);\n\n      if (cachedMessage) {\n        return cachedMessage;\n      }\n\n      var links = {\n        self: this.channel.links.messages + \"/\" + value.sid,\n        conversation: this.channel.links.self,\n        messages_receipts: this.channel.links.messages + \"/\" + value.sid + \"/Receipts\"\n      };\n      var message = new message_1.Message(index, value, this.channel, links, this.configuration, this.services);\n      this.messagesByIndex.set(message.index, message);\n      message.on('updated', function (args) {\n        return _this4.emit('messageUpdated', args);\n      });\n      return message;\n    }\n    /**\n     * Returns last messages from channel\n     * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 30.\n     * @param {String} [anchor] Most early message id which is already known, or 'end' by default\n     * @param {String} [direction] Pagination order 'backwards' or 'forward', or 'forward' by default\n     * @returns {Promise<SyncPaginator<Message>>} last page of messages by default\n     * @private\n     */\n\n  }, {\n    key: \"_getMessages\",\n    value: function _getMessages(pageSize, anchor, direction) {\n      var _this5 = this;\n\n      anchor = typeof anchor !== 'undefined' ? anchor : 'end';\n      pageSize = pageSize || 30;\n      var order = direction === 'backwards' ? 'desc' : 'asc';\n      return this.messagesListPromise.then(function (messagesList) {\n        return messagesList.getItems({\n          from: anchor !== 'end' ? anchor : void 0,\n          pageSize: pageSize,\n          order: order\n        });\n      }).then(function (page) {\n        return _this5.wrapPaginator(order, page, function (items) {\n          return _promise2.default.all(items.map(function (item) {\n            return _this5._upsertMessage(item.index, item.data);\n          }));\n        });\n      });\n    }\n  }]);\n  return Messages;\n}(events_1.EventEmitter);\n\nexports.Messages = Messages;","map":{"version":3,"sources":["/Users/shouryagupta/Desktop/MS Engage 21/MSEngage21_VC/node_modules/twilio-chat/browser/data/messages.js"],"names":["_promise","require","_promise2","_interopRequireDefault","_stringify","_stringify2","_regenerator","_regenerator2","_asyncToGenerator2","_asyncToGenerator3","_map","_map2","_getPrototypeOf","_getPrototypeOf2","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_possibleConstructorReturn2","_possibleConstructorReturn3","_inherits2","_inherits3","obj","__esModule","default","Object","defineProperty","exports","value","Messages","events_1","logger_1","message_1","log","Logger","scope","_events_1$EventEmitte","channel","configuration","services","_this","__proto__","call","messagesByIndex","messagesListPromise","key","subscribe","name","_this2","syncClient","list","id","mode","then","on","args","debug","sid","item","index","links","self","messages","data","conversation","messages_receipts","message","Message","has","set","emit","get","delete","removeAllListeners","_update","catch","err","connectionState","error","_ref","mark","_callee","entity","wrap","_callee$","_context","prev","next","sent","close","stop","unsubscribe","apply","arguments","_ref2","_callee2","attributes","length","undefined","_callee2$","_context2","commandExecutor","mutateResource","body","abrupt","send","_x2","_ref3","_callee3","mediaContent","media","mediaOptions","_callee3$","_context3","FormData","mcsClient","postFormData","contentType","Error","post","media_sid","sendMedia","_x4","getMessages","pageSize","anchor","direction","_getMessages","wrapPaginator","order","page","op","_this3","shouldReverse","np","nextPage","x","pp","prevPage","items","sort","y","hasPrevPage","hasNextPage","_upsertMessage","_this4","cachedMessage","_this5","messagesList","getItems","from","all","map","EventEmitter"],"mappings":"AAAA;;AAEA,IAAIA,QAAQ,GAAGC,OAAO,CAAC,+BAAD,CAAtB;;AAEA,IAAIC,SAAS,GAAGC,sBAAsB,CAACH,QAAD,CAAtC;;AAEA,IAAII,UAAU,GAAGH,OAAO,CAAC,sCAAD,CAAxB;;AAEA,IAAII,WAAW,GAAGF,sBAAsB,CAACC,UAAD,CAAxC;;AAEA,IAAIE,YAAY,GAAGL,OAAO,CAAC,2BAAD,CAA1B;;AAEA,IAAIM,aAAa,GAAGJ,sBAAsB,CAACG,YAAD,CAA1C;;AAEA,IAAIE,kBAAkB,GAAGP,OAAO,CAAC,wCAAD,CAAhC;;AAEA,IAAIQ,kBAAkB,GAAGN,sBAAsB,CAACK,kBAAD,CAA/C;;AAEA,IAAIE,IAAI,GAAGT,OAAO,CAAC,2BAAD,CAAlB;;AAEA,IAAIU,KAAK,GAAGR,sBAAsB,CAACO,IAAD,CAAlC;;AAEA,IAAIE,eAAe,GAAGX,OAAO,CAAC,+CAAD,CAA7B;;AAEA,IAAIY,gBAAgB,GAAGV,sBAAsB,CAACS,eAAD,CAA7C;;AAEA,IAAIE,gBAAgB,GAAGb,OAAO,CAAC,sCAAD,CAA9B;;AAEA,IAAIc,gBAAgB,GAAGZ,sBAAsB,CAACW,gBAAD,CAA7C;;AAEA,IAAIE,aAAa,GAAGf,OAAO,CAAC,mCAAD,CAA3B;;AAEA,IAAIgB,aAAa,GAAGd,sBAAsB,CAACa,aAAD,CAA1C;;AAEA,IAAIE,2BAA2B,GAAGjB,OAAO,CAAC,iDAAD,CAAzC;;AAEA,IAAIkB,2BAA2B,GAAGhB,sBAAsB,CAACe,2BAAD,CAAxD;;AAEA,IAAIE,UAAU,GAAGnB,OAAO,CAAC,gCAAD,CAAxB;;AAEA,IAAIoB,UAAU,GAAGlB,sBAAsB,CAACiB,UAAD,CAAvC;;AAEA,SAASjB,sBAAT,CAAgCmB,GAAhC,EAAqC;AAAE,SAAOA,GAAG,IAAIA,GAAG,CAACC,UAAX,GAAwBD,GAAxB,GAA8B;AAAEE,IAAAA,OAAO,EAAEF;AAAX,GAArC;AAAwD;;AAE/FG,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAD,OAAO,CAACE,QAAR,GAAmB,KAAK,CAAxB;;AACA,IAAIC,QAAQ,GAAG7B,OAAO,CAAC,QAAD,CAAtB;;AACA,IAAI8B,QAAQ,GAAG9B,OAAO,CAAC,WAAD,CAAtB;;AACA,IAAI+B,SAAS,GAAG/B,OAAO,CAAC,YAAD,CAAvB;;AACA,IAAIgC,GAAG,GAAGF,QAAQ,CAACG,MAAT,CAAgBC,KAAhB,CAAsB,UAAtB,CAAV;AACA;AACA;AACA;;AAEA,IAAIN,QAAQ,GAAG,UAAUO,qBAAV,EAAiC;AAC5C,GAAC,GAAGf,UAAU,CAACG,OAAf,EAAwBK,QAAxB,EAAkCO,qBAAlC;;AAEA,WAASP,QAAT,CAAkBQ,OAAlB,EAA2BC,aAA3B,EAA0CC,QAA1C,EAAoD;AAChD,KAAC,GAAGxB,gBAAgB,CAACS,OAArB,EAA8B,IAA9B,EAAoCK,QAApC;;AAEA,QAAIW,KAAK,GAAG,CAAC,GAAGrB,2BAA2B,CAACK,OAAhC,EAAyC,IAAzC,EAA+C,CAACK,QAAQ,CAACY,SAAT,IAAsB,CAAC,GAAG5B,gBAAgB,CAACW,OAArB,EAA8BK,QAA9B,CAAvB,EAAgEa,IAAhE,CAAqE,IAArE,CAA/C,CAAZ;;AAEAF,IAAAA,KAAK,CAACH,OAAN,GAAgBA,OAAhB;AACAG,IAAAA,KAAK,CAACF,aAAN,GAAsBA,aAAtB;AACAE,IAAAA,KAAK,CAACD,QAAN,GAAiBA,QAAjB;AACAC,IAAAA,KAAK,CAACG,eAAN,GAAwB,IAAIhC,KAAK,CAACa,OAAV,EAAxB;AACAgB,IAAAA,KAAK,CAACI,mBAAN,GAA4B,IAA5B;AACA,WAAOJ,KAAP;AACH;AACD;AACJ;AACA;AACA;AACA;;;AAGI,GAAC,GAAGvB,aAAa,CAACO,OAAlB,EAA2BK,QAA3B,EAAqC,CAAC;AAClCgB,IAAAA,GAAG,EAAE,WAD6B;AAElCjB,IAAAA,KAAK,EAAE,SAASkB,SAAT,CAAmBC,IAAnB,EAAyB;AAC5B,UAAIC,MAAM,GAAG,IAAb;;AAEA,aAAO,KAAKJ,mBAAL,GAA2B,KAAKA,mBAAL,IAA4B,KAAKL,QAAL,CAAcU,UAAd,CAAyBC,IAAzB,CAA8B;AAAEC,QAAAA,EAAE,EAAEJ,IAAN;AAAYK,QAAAA,IAAI,EAAE;AAAlB,OAA9B,EAAmEC,IAAnE,CAAwE,UAAUH,IAAV,EAAgB;AAClJA,QAAAA,IAAI,CAACI,EAAL,CAAQ,WAAR,EAAqB,UAAUC,IAAV,EAAgB;AACjCtB,UAAAA,GAAG,CAACuB,KAAJ,CAAUR,MAAM,CAACX,OAAP,CAAeoB,GAAf,GAAqB,cAArB,GAAsCF,IAAI,CAACG,IAAL,CAAUC,KAA1D;AACA,cAAIC,KAAK,GAAG;AACRC,YAAAA,IAAI,EAAEb,MAAM,CAACX,OAAP,CAAeuB,KAAf,CAAqBE,QAArB,GAAgC,GAAhC,GAAsCP,IAAI,CAACG,IAAL,CAAUK,IAAV,CAAeN,GADnD;AAERO,YAAAA,YAAY,EAAEhB,MAAM,CAACX,OAAP,CAAeuB,KAAf,CAAqBC,IAF3B;AAGRI,YAAAA,iBAAiB,EAAEjB,MAAM,CAACX,OAAP,CAAeuB,KAAf,CAAqBE,QAArB,GAAgC,GAAhC,GAAsCP,IAAI,CAACG,IAAL,CAAUK,IAAV,CAAeN,GAArD,GAA2D;AAHtE,WAAZ;AAKA,cAAIS,OAAO,GAAG,IAAIlC,SAAS,CAACmC,OAAd,CAAsBZ,IAAI,CAACG,IAAL,CAAUC,KAAhC,EAAuCJ,IAAI,CAACG,IAAL,CAAUK,IAAjD,EAAuDf,MAAM,CAACX,OAA9D,EAAuEuB,KAAvE,EAA8EZ,MAAM,CAACV,aAArF,EAAoGU,MAAM,CAACT,QAA3G,CAAd;;AACA,cAAIS,MAAM,CAACL,eAAP,CAAuByB,GAAvB,CAA2BF,OAAO,CAACP,KAAnC,CAAJ,EAA+C;AAC3C1B,YAAAA,GAAG,CAACuB,KAAJ,CAAU,gDAAV,EAA4DR,MAAM,CAACX,OAAP,CAAeoB,GAA3E,EAAgFS,OAAO,CAACP,KAAxF;AACA;AACH;;AACDX,UAAAA,MAAM,CAACL,eAAP,CAAuB0B,GAAvB,CAA2BH,OAAO,CAACP,KAAnC,EAA0CO,OAA1C;;AACAA,UAAAA,OAAO,CAACZ,EAAR,CAAW,SAAX,EAAsB,UAAUC,IAAV,EAAgB;AAClC,mBAAOP,MAAM,CAACsB,IAAP,CAAY,gBAAZ,EAA8Bf,IAA9B,CAAP;AACH,WAFD;;AAGAP,UAAAA,MAAM,CAACsB,IAAP,CAAY,cAAZ,EAA4BJ,OAA5B;AACH,SAjBD;AAkBAhB,QAAAA,IAAI,CAACI,EAAL,CAAQ,aAAR,EAAuB,UAAUC,IAAV,EAAgB;AACnCtB,UAAAA,GAAG,CAACuB,KAAJ,CAAUR,MAAM,CAACX,OAAP,CAAeoB,GAAf,GAAqB,gBAArB,GAAwCF,IAAI,CAACI,KAAvD;AACA,cAAIA,KAAK,GAAGJ,IAAI,CAACI,KAAjB;;AACA,cAAIX,MAAM,CAACL,eAAP,CAAuByB,GAAvB,CAA2BT,KAA3B,CAAJ,EAAuC;AACnC,gBAAIO,OAAO,GAAGlB,MAAM,CAACL,eAAP,CAAuB4B,GAAvB,CAA2BZ,KAA3B,CAAd;;AACAX,YAAAA,MAAM,CAACL,eAAP,CAAuB6B,MAAvB,CAA8BN,OAAO,CAACP,KAAtC;;AACAO,YAAAA,OAAO,CAACO,kBAAR,CAA2B,SAA3B;;AACAzB,YAAAA,MAAM,CAACsB,IAAP,CAAY,gBAAZ,EAA8BJ,OAA9B;AACH;AACJ,SATD;AAUAhB,QAAAA,IAAI,CAACI,EAAL,CAAQ,aAAR,EAAuB,UAAUC,IAAV,EAAgB;AACnCtB,UAAAA,GAAG,CAACuB,KAAJ,CAAUR,MAAM,CAACX,OAAP,CAAeoB,GAAf,GAAqB,gBAArB,GAAwCF,IAAI,CAACG,IAAL,CAAUC,KAA5D;;AACA,cAAIO,OAAO,GAAGlB,MAAM,CAACL,eAAP,CAAuB4B,GAAvB,CAA2BhB,IAAI,CAACG,IAAL,CAAUC,KAArC,CAAd;;AACA,cAAIO,OAAJ,EAAa;AACTA,YAAAA,OAAO,CAACQ,OAAR,CAAgBnB,IAAI,CAACG,IAAL,CAAUK,IAA1B;AACH;AACJ,SAND;AAOA,eAAOb,IAAP;AACH,OArC6D,EAqC3DyB,KArC2D,CAqCrD,UAAUC,GAAV,EAAe;AACpB5B,QAAAA,MAAM,CAACJ,mBAAP,GAA6B,IAA7B;;AACA,YAAII,MAAM,CAACT,QAAP,CAAgBU,UAAhB,CAA2B4B,eAA3B,IAA8C,cAAlD,EAAkE;AAC9D5C,UAAAA,GAAG,CAAC6C,KAAJ,CAAU,2CAAV,EAAuD9B,MAAM,CAACX,OAAP,CAAeoB,GAAtE,EAA2EmB,GAA3E;AACH;;AACD3C,QAAAA,GAAG,CAACuB,KAAJ,CAAU,kDAAV,EAA8DR,MAAM,CAACX,OAAP,CAAeoB,GAA7E,EAAkFmB,GAAlF;AACA,cAAMA,GAAN;AACH,OA5C6D,CAA9D;AA6CH;AAlDiC,GAAD,EAmDlC;AACC/B,IAAAA,GAAG,EAAE,aADN;AAECjB,IAAAA,KAAK,EAAE,YAAY;AACf,UAAImD,IAAI,GAAG,CAAC,GAAGtE,kBAAkB,CAACe,OAAvB,GAAiC,aAAajB,aAAa,CAACiB,OAAd,CAAsBwD,IAAtB,CAA2B,SAASC,OAAT,GAAmB;AACnG,YAAIC,MAAJ;AACA,eAAO3E,aAAa,CAACiB,OAAd,CAAsB2D,IAAtB,CAA2B,SAASC,QAAT,CAAkBC,QAAlB,EAA4B;AAC1D,iBAAO,CAAP,EAAU;AACN,oBAAQA,QAAQ,CAACC,IAAT,GAAgBD,QAAQ,CAACE,IAAjC;AACI,mBAAK,CAAL;AACI,oBAAI,CAAC,KAAK3C,mBAAV,EAA+B;AAC3ByC,kBAAAA,QAAQ,CAACE,IAAT,GAAgB,CAAhB;AACA;AACH;;AAEDF,gBAAAA,QAAQ,CAACE,IAAT,GAAgB,CAAhB;AACA,uBAAO,KAAK3C,mBAAZ;;AAEJ,mBAAK,CAAL;AACIsC,gBAAAA,MAAM,GAAGG,QAAQ,CAACG,IAAlB;AAEAN,gBAAAA,MAAM,CAACO,KAAP;AACA,qBAAK7C,mBAAL,GAA2B,IAA3B;;AAEJ,mBAAK,CAAL;AACA,mBAAK,KAAL;AACI,uBAAOyC,QAAQ,CAACK,IAAT,EAAP;AAlBR;AAoBH;AACJ,SAvBM,EAuBJT,OAvBI,EAuBK,IAvBL,CAAP;AAwBH,OA1BwD,CAA9C,CAAX;;AA4BA,eAASU,WAAT,GAAuB;AACnB,eAAOZ,IAAI,CAACa,KAAL,CAAW,IAAX,EAAiBC,SAAjB,CAAP;AACH;;AAED,aAAOF,WAAP;AACH,KAlCM;AAmCP;AACR;AACA;AACA;AACA;AACA;;AA1CO,GAnDkC,EA+FlC;AACC9C,IAAAA,GAAG,EAAE,MADN;AAECjB,IAAAA,KAAK,EAAE,YAAY;AACf,UAAIkE,KAAK,GAAG,CAAC,GAAGrF,kBAAkB,CAACe,OAAvB,GAAiC,aAAajB,aAAa,CAACiB,OAAd,CAAsBwD,IAAtB,CAA2B,SAASe,QAAT,CAAkB7B,OAAlB,EAA2B;AAC5G,YAAI8B,UAAU,GAAGH,SAAS,CAACI,MAAV,GAAmB,CAAnB,IAAwBJ,SAAS,CAAC,CAAD,CAAT,KAAiBK,SAAzC,GAAqDL,SAAS,CAAC,CAAD,CAA9D,GAAoE,EAArF;AACA,eAAOtF,aAAa,CAACiB,OAAd,CAAsB2D,IAAtB,CAA2B,SAASgB,SAAT,CAAmBC,SAAnB,EAA8B;AAC5D,iBAAO,CAAP,EAAU;AACN,oBAAQA,SAAS,CAACd,IAAV,GAAiBc,SAAS,CAACb,IAAnC;AACI,mBAAK,CAAL;AACItD,gBAAAA,GAAG,CAACuB,KAAJ,CAAU,sBAAV,EAAkCU,OAAlC,EAA2C8B,UAA3C;AACAI,gBAAAA,SAAS,CAACb,IAAV,GAAiB,CAAjB;AACA,uBAAO,KAAKhD,QAAL,CAAc8D,eAAd,CAA8BC,cAA9B,CAA6C,MAA7C,EAAqD,KAAKjE,OAAL,CAAauB,KAAb,CAAmBE,QAAxE,EAAkF;AACrFyC,kBAAAA,IAAI,EAAErC,OAAO,IAAI,EADoE;AAErF8B,kBAAAA,UAAU,EAAEA,UAAU,KAAKE,SAAf,GAA2B,CAAC,GAAG7F,WAAW,CAACmB,OAAhB,EAAyBwE,UAAzB,CAA3B,GAAkEE;AAFO,iBAAlF,CAAP;;AAKJ,mBAAK,CAAL;AACI,uBAAOE,SAAS,CAACI,MAAV,CAAiB,QAAjB,EAA2BJ,SAAS,CAACZ,IAArC,CAAP;;AAEJ,mBAAK,CAAL;AACA,mBAAK,KAAL;AACI,uBAAOY,SAAS,CAACV,IAAV,EAAP;AAdR;AAgBH;AACJ,SAnBM,EAmBJK,QAnBI,EAmBM,IAnBN,CAAP;AAoBH,OAtByD,CAA9C,CAAZ;;AAwBA,eAASU,IAAT,CAAcC,GAAd,EAAmB;AACf,eAAOZ,KAAK,CAACF,KAAN,CAAY,IAAZ,EAAkBC,SAAlB,CAAP;AACH;;AAED,aAAOY,IAAP;AACH,KA9BM;AA+BP;AACR;AACA;AACA;AACA;AACA;;AAtCO,GA/FkC,EAuIlC;AACC5D,IAAAA,GAAG,EAAE,WADN;AAECjB,IAAAA,KAAK,EAAE,YAAY;AACf,UAAI+E,KAAK,GAAG,CAAC,GAAGlG,kBAAkB,CAACe,OAAvB,GAAiC,aAAajB,aAAa,CAACiB,OAAd,CAAsBwD,IAAtB,CAA2B,SAAS4B,QAAT,CAAkBC,YAAlB,EAAgC;AACjH,YAAIb,UAAU,GAAGH,SAAS,CAACI,MAAV,GAAmB,CAAnB,IAAwBJ,SAAS,CAAC,CAAD,CAAT,KAAiBK,SAAzC,GAAqDL,SAAS,CAAC,CAAD,CAA9D,GAAoE,EAArF;AACA,YAAIiB,KAAJ,EAAWC,YAAX;AACA,eAAOxG,aAAa,CAACiB,OAAd,CAAsB2D,IAAtB,CAA2B,SAAS6B,SAAT,CAAmBC,SAAnB,EAA8B;AAC5D,iBAAO,CAAP,EAAU;AACN,oBAAQA,SAAS,CAAC3B,IAAV,GAAiB2B,SAAS,CAAC1B,IAAnC;AACI,mBAAK,CAAL;AACItD,gBAAAA,GAAG,CAACuB,KAAJ,CAAU,uBAAV,EAAmCqD,YAAnC,EAAiDb,UAAjD;AACAc,gBAAAA,KAAK,GAAG,KAAK,CAAb;;AAEA,oBAAI,EAAE,OAAOI,QAAP,KAAoB,WAApB,IAAmCL,YAAY,YAAYK,QAA7D,CAAJ,EAA4E;AACxED,kBAAAA,SAAS,CAAC1B,IAAV,GAAiB,CAAjB;AACA;AACH;;AAEDtD,gBAAAA,GAAG,CAACuB,KAAJ,CAAU,mCAAV,EAA+CqD,YAA/C,EAA6Db,UAA7D;AACAiB,gBAAAA,SAAS,CAAC1B,IAAV,GAAiB,CAAjB;AACA,uBAAO,KAAKhD,QAAL,CAAc4E,SAAd,CAAwBC,YAAxB,CAAqCP,YAArC,CAAP;;AAEJ,mBAAK,CAAL;AACIC,gBAAAA,KAAK,GAAGG,SAAS,CAACzB,IAAlB;AACAyB,gBAAAA,SAAS,CAAC1B,IAAV,GAAiB,EAAjB;AACA;;AAEJ,mBAAK,CAAL;AACItD,gBAAAA,GAAG,CAACuB,KAAJ,CAAU,2CAAV,EAAuDqD,YAAvD,EAAqEb,UAArE;AACAe,gBAAAA,YAAY,GAAGF,YAAf;;AAEA,oBAAI,EAAE,CAACE,YAAY,CAACM,WAAd,IAA6B,CAACN,YAAY,CAACD,KAA7C,CAAJ,EAAyD;AACrDG,kBAAAA,SAAS,CAAC1B,IAAV,GAAiB,EAAjB;AACA;AACH;;AAED,sBAAM,IAAI+B,KAAJ,CAAU,uFAAV,CAAN;;AAEJ,mBAAK,EAAL;AACIL,gBAAAA,SAAS,CAAC1B,IAAV,GAAiB,EAAjB;AACA,uBAAO,KAAKhD,QAAL,CAAc4E,SAAd,CAAwBI,IAAxB,CAA6BR,YAAY,CAACM,WAA1C,EAAuDN,YAAY,CAACD,KAApE,CAAP;;AAEJ,mBAAK,EAAL;AACIA,gBAAAA,KAAK,GAAGG,SAAS,CAACzB,IAAlB;;AAEJ,mBAAK,EAAL;AACIyB,gBAAAA,SAAS,CAAC1B,IAAV,GAAiB,EAAjB;AACA,uBAAO,KAAKhD,QAAL,CAAc8D,eAAd,CAA8BC,cAA9B,CAA6C,MAA7C,EAAqD,KAAKjE,OAAL,CAAauB,KAAb,CAAmBE,QAAxE,EAAkF;AACrF0D,kBAAAA,SAAS,EAAEV,KAAK,CAACrD,GADoE;AAErFuC,kBAAAA,UAAU,EAAEA,UAAU,KAAKE,SAAf,GAA2B,CAAC,GAAG7F,WAAW,CAACmB,OAAhB,EAAyBwE,UAAzB,CAA3B,GAAkEE;AAFO,iBAAlF,CAAP;;AAKJ,mBAAK,EAAL;AACI,uBAAOe,SAAS,CAACT,MAAV,CAAiB,QAAjB,EAA2BS,SAAS,CAACzB,IAArC,CAAP;;AAEJ,mBAAK,EAAL;AACA,mBAAK,KAAL;AACI,uBAAOyB,SAAS,CAACvB,IAAV,EAAP;AAjDR;AAmDH;AACJ,SAtDM,EAsDJkB,QAtDI,EAsDM,IAtDN,CAAP;AAuDH,OA1DyD,CAA9C,CAAZ;;AA4DA,eAASa,SAAT,CAAmBC,GAAnB,EAAwB;AACpB,eAAOf,KAAK,CAACf,KAAN,CAAY,IAAZ,EAAkBC,SAAlB,CAAP;AACH;;AAED,aAAO4B,SAAP;AACH,KAlEM;AAmEP;AACR;AACA;AACA;AACA;AACA;AACA;;AA3EO,GAvIkC,EAoNlC;AACC5E,IAAAA,GAAG,EAAE,aADN;AAECjB,IAAAA,KAAK,EAAE,SAAS+F,WAAT,CAAqBC,QAArB,EAA+BC,MAA/B,EAAuCC,SAAvC,EAAkD;AACrDD,MAAAA,MAAM,GAAG,OAAOA,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,KAAlD;AACAC,MAAAA,SAAS,GAAGA,SAAS,IAAI,WAAzB;AACA,aAAO,KAAKC,YAAL,CAAkBH,QAAlB,EAA4BC,MAA5B,EAAoCC,SAApC,CAAP;AACH;AANF,GApNkC,EA2NlC;AACCjF,IAAAA,GAAG,EAAE,eADN;AAECjB,IAAAA,KAAK,EAAE,SAASoG,aAAT,CAAuBC,KAAvB,EAA8BC,IAA9B,EAAoCC,EAApC,EAAwC;AAC3C,UAAIC,MAAM,GAAG,IAAb,CAD2C,CAG3C;;;AACA,UAAIC,aAAa,GAAGJ,KAAK,KAAK,MAA9B;;AACA,UAAIK,EAAE,GAAG,SAASA,EAAT,GAAc;AACnB,eAAOJ,IAAI,CAACK,QAAL,GAAgBlF,IAAhB,CAAqB,UAAUmF,CAAV,EAAa;AACrC,iBAAOJ,MAAM,CAACJ,aAAP,CAAqBC,KAArB,EAA4BO,CAA5B,EAA+BL,EAA/B,CAAP;AACH,SAFM,CAAP;AAGH,OAJD;;AAKA,UAAIM,EAAE,GAAG,SAASA,EAAT,GAAc;AACnB,eAAOP,IAAI,CAACQ,QAAL,GAAgBrF,IAAhB,CAAqB,UAAUmF,CAAV,EAAa;AACrC,iBAAOJ,MAAM,CAACJ,aAAP,CAAqBC,KAArB,EAA4BO,CAA5B,EAA+BL,EAA/B,CAAP;AACH,SAFM,CAAP;AAGH,OAJD;;AAKA,aAAOA,EAAE,CAACD,IAAI,CAACS,KAAN,CAAF,CAAetF,IAAf,CAAoB,UAAUsF,KAAV,EAAiB;AACxC,eAAO;AACHA,UAAAA,KAAK,EAAEA,KAAK,CAACC,IAAN,CAAW,UAAUJ,CAAV,EAAaK,CAAb,EAAgB;AAC9B,mBAAOL,CAAC,CAAC7E,KAAF,GAAUkF,CAAC,CAAClF,KAAnB;AACH,WAFM,CADJ;AAIHmF,UAAAA,WAAW,EAAET,aAAa,GAAGH,IAAI,CAACa,WAAR,GAAsBb,IAAI,CAACY,WAJlD;AAKHC,UAAAA,WAAW,EAAEV,aAAa,GAAGH,IAAI,CAACY,WAAR,GAAsBZ,IAAI,CAACa,WALlD;AAMHL,UAAAA,QAAQ,EAAEL,aAAa,GAAGC,EAAH,GAAQG,EAN5B;AAOHF,UAAAA,QAAQ,EAAEF,aAAa,GAAGI,EAAH,GAAQH;AAP5B,SAAP;AASH,OAVM,CAAP;AAWH;AA5BF,GA3NkC,EAwPlC;AACCzF,IAAAA,GAAG,EAAE,gBADN;AAECjB,IAAAA,KAAK,EAAE,SAASoH,cAAT,CAAwBrF,KAAxB,EAA+B/B,KAA/B,EAAsC;AACzC,UAAIqH,MAAM,GAAG,IAAb;;AAEA,UAAIC,aAAa,GAAG,KAAKvG,eAAL,CAAqB4B,GAArB,CAAyBZ,KAAzB,CAApB;;AACA,UAAIuF,aAAJ,EAAmB;AACf,eAAOA,aAAP;AACH;;AACD,UAAItF,KAAK,GAAG;AACRC,QAAAA,IAAI,EAAE,KAAKxB,OAAL,CAAauB,KAAb,CAAmBE,QAAnB,GAA8B,GAA9B,GAAoClC,KAAK,CAAC6B,GADxC;AAERO,QAAAA,YAAY,EAAE,KAAK3B,OAAL,CAAauB,KAAb,CAAmBC,IAFzB;AAGRI,QAAAA,iBAAiB,EAAE,KAAK5B,OAAL,CAAauB,KAAb,CAAmBE,QAAnB,GAA8B,GAA9B,GAAoClC,KAAK,CAAC6B,GAA1C,GAAgD;AAH3D,OAAZ;AAKA,UAAIS,OAAO,GAAG,IAAIlC,SAAS,CAACmC,OAAd,CAAsBR,KAAtB,EAA6B/B,KAA7B,EAAoC,KAAKS,OAAzC,EAAkDuB,KAAlD,EAAyD,KAAKtB,aAA9D,EAA6E,KAAKC,QAAlF,CAAd;AACA,WAAKI,eAAL,CAAqB0B,GAArB,CAAyBH,OAAO,CAACP,KAAjC,EAAwCO,OAAxC;AACAA,MAAAA,OAAO,CAACZ,EAAR,CAAW,SAAX,EAAsB,UAAUC,IAAV,EAAgB;AAClC,eAAO0F,MAAM,CAAC3E,IAAP,CAAY,gBAAZ,EAA8Bf,IAA9B,CAAP;AACH,OAFD;AAGA,aAAOW,OAAP;AACH;AACD;AACR;AACA;AACA;AACA;AACA;AACA;AACA;;AA5BO,GAxPkC,EAsRlC;AACCrB,IAAAA,GAAG,EAAE,cADN;AAECjB,IAAAA,KAAK,EAAE,SAASmG,YAAT,CAAsBH,QAAtB,EAAgCC,MAAhC,EAAwCC,SAAxC,EAAmD;AACtD,UAAIqB,MAAM,GAAG,IAAb;;AAEAtB,MAAAA,MAAM,GAAG,OAAOA,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,KAAlD;AACAD,MAAAA,QAAQ,GAAGA,QAAQ,IAAI,EAAvB;AACA,UAAIK,KAAK,GAAGH,SAAS,KAAK,WAAd,GAA4B,MAA5B,GAAqC,KAAjD;AACA,aAAO,KAAKlF,mBAAL,CAAyBS,IAAzB,CAA8B,UAAU+F,YAAV,EAAwB;AACzD,eAAOA,YAAY,CAACC,QAAb,CAAsB;AACzBC,UAAAA,IAAI,EAAEzB,MAAM,KAAK,KAAX,GAAmBA,MAAnB,GAA4B,KAAK,CADd;AAEzBD,UAAAA,QAAQ,EAAEA,QAFe;AAGzBK,UAAAA,KAAK,EAAEA;AAHkB,SAAtB,CAAP;AAKH,OANM,EAMJ5E,IANI,CAMC,UAAU6E,IAAV,EAAgB;AACpB,eAAOiB,MAAM,CAACnB,aAAP,CAAqBC,KAArB,EAA4BC,IAA5B,EAAkC,UAAUS,KAAV,EAAiB;AACtD,iBAAOzI,SAAS,CAACsB,OAAV,CAAkB+H,GAAlB,CAAsBZ,KAAK,CAACa,GAAN,CAAU,UAAU9F,IAAV,EAAgB;AACnD,mBAAOyF,MAAM,CAACH,cAAP,CAAsBtF,IAAI,CAACC,KAA3B,EAAkCD,IAAI,CAACK,IAAvC,CAAP;AACH,WAF4B,CAAtB,CAAP;AAGH,SAJM,CAAP;AAKH,OAZM,CAAP;AAaH;AArBF,GAtRkC,CAArC;AA6SA,SAAOlC,QAAP;AACH,CApUc,CAoUbC,QAAQ,CAAC2H,YApUI,CAAf;;AAsUA9H,OAAO,CAACE,QAAR,GAAmBA,QAAnB","sourcesContent":["\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _stringify = require(\"babel-runtime/core-js/json/stringify\");\n\nvar _stringify2 = _interopRequireDefault(_stringify);\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Messages = void 0;\nvar events_1 = require(\"events\");\nvar logger_1 = require(\"../logger\");\nvar message_1 = require(\"../message\");\nvar log = logger_1.Logger.scope('Messages');\n/**\n * Represents the collection of messages in a channel\n */\n\nvar Messages = function (_events_1$EventEmitte) {\n    (0, _inherits3.default)(Messages, _events_1$EventEmitte);\n\n    function Messages(channel, configuration, services) {\n        (0, _classCallCheck3.default)(this, Messages);\n\n        var _this = (0, _possibleConstructorReturn3.default)(this, (Messages.__proto__ || (0, _getPrototypeOf2.default)(Messages)).call(this));\n\n        _this.channel = channel;\n        _this.configuration = configuration;\n        _this.services = services;\n        _this.messagesByIndex = new _map2.default();\n        _this.messagesListPromise = null;\n        return _this;\n    }\n    /**\n     * Subscribe to the Messages Event Stream\n     * @param {String} name - The name of Sync object for the Messages resource.\n     * @returns {Promise}\n     */\n\n\n    (0, _createClass3.default)(Messages, [{\n        key: \"subscribe\",\n        value: function subscribe(name) {\n            var _this2 = this;\n\n            return this.messagesListPromise = this.messagesListPromise || this.services.syncClient.list({ id: name, mode: 'open_existing' }).then(function (list) {\n                list.on('itemAdded', function (args) {\n                    log.debug(_this2.channel.sid + ' itemAdded: ' + args.item.index);\n                    var links = {\n                        self: _this2.channel.links.messages + \"/\" + args.item.data.sid,\n                        conversation: _this2.channel.links.self,\n                        messages_receipts: _this2.channel.links.messages + \"/\" + args.item.data.sid + \"/Receipts\"\n                    };\n                    var message = new message_1.Message(args.item.index, args.item.data, _this2.channel, links, _this2.configuration, _this2.services);\n                    if (_this2.messagesByIndex.has(message.index)) {\n                        log.debug('Message arrived, but already known and ignored', _this2.channel.sid, message.index);\n                        return;\n                    }\n                    _this2.messagesByIndex.set(message.index, message);\n                    message.on('updated', function (args) {\n                        return _this2.emit('messageUpdated', args);\n                    });\n                    _this2.emit('messageAdded', message);\n                });\n                list.on('itemRemoved', function (args) {\n                    log.debug(_this2.channel.sid + ' itemRemoved: ' + args.index);\n                    var index = args.index;\n                    if (_this2.messagesByIndex.has(index)) {\n                        var message = _this2.messagesByIndex.get(index);\n                        _this2.messagesByIndex.delete(message.index);\n                        message.removeAllListeners('updated');\n                        _this2.emit('messageRemoved', message);\n                    }\n                });\n                list.on('itemUpdated', function (args) {\n                    log.debug(_this2.channel.sid + ' itemUpdated: ' + args.item.index);\n                    var message = _this2.messagesByIndex.get(args.item.index);\n                    if (message) {\n                        message._update(args.item.data);\n                    }\n                });\n                return list;\n            }).catch(function (err) {\n                _this2.messagesListPromise = null;\n                if (_this2.services.syncClient.connectionState != 'disconnected') {\n                    log.error('Failed to get messages object for channel', _this2.channel.sid, err);\n                }\n                log.debug('ERROR: Failed to get messages object for channel', _this2.channel.sid, err);\n                throw err;\n            });\n        }\n    }, {\n        key: \"unsubscribe\",\n        value: function () {\n            var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n                var entity;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                if (!this.messagesListPromise) {\n                                    _context.next = 6;\n                                    break;\n                                }\n\n                                _context.next = 3;\n                                return this.messagesListPromise;\n\n                            case 3:\n                                entity = _context.sent;\n\n                                entity.close();\n                                this.messagesListPromise = null;\n\n                            case 6:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function unsubscribe() {\n                return _ref.apply(this, arguments);\n            }\n\n            return unsubscribe;\n        }()\n        /**\n         * Send Message to the channel\n         * @param {String} message - Message to post\n         * @param {any} attributes Message attributes\n         * @returns Returns promise which can fail\n         */\n\n    }, {\n        key: \"send\",\n        value: function () {\n            var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(message) {\n                var attributes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n                return _regenerator2.default.wrap(function _callee2$(_context2) {\n                    while (1) {\n                        switch (_context2.prev = _context2.next) {\n                            case 0:\n                                log.debug('Sending text message', message, attributes);\n                                _context2.next = 3;\n                                return this.services.commandExecutor.mutateResource('post', this.channel.links.messages, {\n                                    body: message || '',\n                                    attributes: attributes !== undefined ? (0, _stringify2.default)(attributes) : undefined\n                                });\n\n                            case 3:\n                                return _context2.abrupt(\"return\", _context2.sent);\n\n                            case 4:\n                            case \"end\":\n                                return _context2.stop();\n                        }\n                    }\n                }, _callee2, this);\n            }));\n\n            function send(_x2) {\n                return _ref2.apply(this, arguments);\n            }\n\n            return send;\n        }()\n        /**\n         * Send Media Message to the channel\n         * @param {FormData | Channel#SendMediaOptions} mediaContent - Media content to post\n         * @param {any} attributes Message attributes\n         * @returns Returns promise which can fail\n         */\n\n    }, {\n        key: \"sendMedia\",\n        value: function () {\n            var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(mediaContent) {\n                var attributes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n                var media, mediaOptions;\n                return _regenerator2.default.wrap(function _callee3$(_context3) {\n                    while (1) {\n                        switch (_context3.prev = _context3.next) {\n                            case 0:\n                                log.debug('Sending media message', mediaContent, attributes);\n                                media = void 0;\n\n                                if (!(typeof FormData !== 'undefined' && mediaContent instanceof FormData)) {\n                                    _context3.next = 9;\n                                    break;\n                                }\n\n                                log.debug('Sending media message as FormData', mediaContent, attributes);\n                                _context3.next = 6;\n                                return this.services.mcsClient.postFormData(mediaContent);\n\n                            case 6:\n                                media = _context3.sent;\n                                _context3.next = 16;\n                                break;\n\n                            case 9:\n                                log.debug('Sending media message as SendMediaOptions', mediaContent, attributes);\n                                mediaOptions = mediaContent;\n\n                                if (!(!mediaOptions.contentType || !mediaOptions.media)) {\n                                    _context3.next = 13;\n                                    break;\n                                }\n\n                                throw new Error('Media content <Channel#SendMediaOptions> must contain non-empty contentType and media');\n\n                            case 13:\n                                _context3.next = 15;\n                                return this.services.mcsClient.post(mediaOptions.contentType, mediaOptions.media);\n\n                            case 15:\n                                media = _context3.sent;\n\n                            case 16:\n                                _context3.next = 18;\n                                return this.services.commandExecutor.mutateResource('post', this.channel.links.messages, {\n                                    media_sid: media.sid,\n                                    attributes: attributes !== undefined ? (0, _stringify2.default)(attributes) : undefined\n                                });\n\n                            case 18:\n                                return _context3.abrupt(\"return\", _context3.sent);\n\n                            case 19:\n                            case \"end\":\n                                return _context3.stop();\n                        }\n                    }\n                }, _callee3, this);\n            }));\n\n            function sendMedia(_x4) {\n                return _ref3.apply(this, arguments);\n            }\n\n            return sendMedia;\n        }()\n        /**\n         * Returns messages from channel using paginator interface\n         * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 30.\n         * @param {String} [anchor] Most early message id which is already known, or 'end' by default\n         * @param {String} [direction] Pagination order 'backwards' or 'forward', or 'forward' by default\n         * @returns {Promise<Paginator<Message>>} last page of messages by default\n         */\n\n    }, {\n        key: \"getMessages\",\n        value: function getMessages(pageSize, anchor, direction) {\n            anchor = typeof anchor !== 'undefined' ? anchor : 'end';\n            direction = direction || 'backwards';\n            return this._getMessages(pageSize, anchor, direction);\n        }\n    }, {\n        key: \"wrapPaginator\",\n        value: function wrapPaginator(order, page, op) {\n            var _this3 = this;\n\n            // We should swap next and prev page here, because of misfit of Sync and Chat paging conceptions\n            var shouldReverse = order === 'desc';\n            var np = function np() {\n                return page.nextPage().then(function (x) {\n                    return _this3.wrapPaginator(order, x, op);\n                });\n            };\n            var pp = function pp() {\n                return page.prevPage().then(function (x) {\n                    return _this3.wrapPaginator(order, x, op);\n                });\n            };\n            return op(page.items).then(function (items) {\n                return {\n                    items: items.sort(function (x, y) {\n                        return x.index - y.index;\n                    }),\n                    hasPrevPage: shouldReverse ? page.hasNextPage : page.hasPrevPage,\n                    hasNextPage: shouldReverse ? page.hasPrevPage : page.hasNextPage,\n                    prevPage: shouldReverse ? np : pp,\n                    nextPage: shouldReverse ? pp : np\n                };\n            });\n        }\n    }, {\n        key: \"_upsertMessage\",\n        value: function _upsertMessage(index, value) {\n            var _this4 = this;\n\n            var cachedMessage = this.messagesByIndex.get(index);\n            if (cachedMessage) {\n                return cachedMessage;\n            }\n            var links = {\n                self: this.channel.links.messages + \"/\" + value.sid,\n                conversation: this.channel.links.self,\n                messages_receipts: this.channel.links.messages + \"/\" + value.sid + \"/Receipts\"\n            };\n            var message = new message_1.Message(index, value, this.channel, links, this.configuration, this.services);\n            this.messagesByIndex.set(message.index, message);\n            message.on('updated', function (args) {\n                return _this4.emit('messageUpdated', args);\n            });\n            return message;\n        }\n        /**\n         * Returns last messages from channel\n         * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 30.\n         * @param {String} [anchor] Most early message id which is already known, or 'end' by default\n         * @param {String} [direction] Pagination order 'backwards' or 'forward', or 'forward' by default\n         * @returns {Promise<SyncPaginator<Message>>} last page of messages by default\n         * @private\n         */\n\n    }, {\n        key: \"_getMessages\",\n        value: function _getMessages(pageSize, anchor, direction) {\n            var _this5 = this;\n\n            anchor = typeof anchor !== 'undefined' ? anchor : 'end';\n            pageSize = pageSize || 30;\n            var order = direction === 'backwards' ? 'desc' : 'asc';\n            return this.messagesListPromise.then(function (messagesList) {\n                return messagesList.getItems({\n                    from: anchor !== 'end' ? anchor : void 0,\n                    pageSize: pageSize,\n                    order: order\n                });\n            }).then(function (page) {\n                return _this5.wrapPaginator(order, page, function (items) {\n                    return _promise2.default.all(items.map(function (item) {\n                        return _this5._upsertMessage(item.index, item.data);\n                    }));\n                });\n            });\n        }\n    }]);\n    return Messages;\n}(events_1.EventEmitter);\n\nexports.Messages = Messages;"]},"metadata":{},"sourceType":"script"}